<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Auditoría PPR</title>
  <style>
    .evidencia { display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <form id="auditoriaForm">
    <h1>Auditoría TS FSSC 22002</h1>
    
    <div class="pregunta">
      <p>1. ¿Se cumple con X requisito?</p>
      <label><input type="radio" name="p1" value="cumple"> Cumple</label>
      <label><input type="radio" name="p1" value="parcial"> Cumple Parcial</label>
      <label><input type="radio" name="p1" value="no_cumple"> No Cumple</label>
      
      <div class="evidencia" id="evidencia1">
        <input type="file" accept="image/*" capture="camera">
      </div>
    </div>
    
    <!-- Más preguntas... -->
    
    <button type="submit">Generar Reporte</button>
  </form>

  <script>
    const AUDITORIA_ID = Date.now().toString();
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHdPxorU-5fsKq-yUMOm1WXfYwF-rlDaA-cNDuZjCW5j71D0q7fjcZjD_YcaQVuDorrw/exec";
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const evidenciaDiv = e.target.closest('.pregunta').querySelector('.evidencia');
        if (e.target.value === 'parcial' || e.target.value === 'no_cumple') {
          evidenciaDiv.style.display = 'block';
        } else {
          evidenciaDiv.style.display = 'none';
        }
      });
    });

    document.getElementById('auditoriaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Recopilar respuestas
      const respuestas = [];
      document.querySelectorAll('.pregunta').forEach((pregunta, index) => {
        const respuesta = pregunta.querySelector('input:checked').value;
        const evidenciaInput = pregunta.querySelector('input[type="file"]');
        
        respuestas.push({
          pregunta: `Pregunta ${index+1}`,
          respuesta: respuesta,
          evidencia: evidenciaInput?.files[0] || null
        });
      });
      
      // Enviar datos
      for (const res of respuestas) {
        let evidenciaUrl = '';
        
        if (res.evidencia) {
          const reader = new FileReader();
          const base64 = await new Promise(resolve => {
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(res.evidencia);
          });
          evidenciaUrl = await uploadImage(base64);
        }
        
        await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            auditor: "Nombre Auditor",
            pregunta: res.pregunta,
            respuesta: res.respuesta,
            evidencia: evidenciaUrl,
            auditoriaId: AUDITORIA_ID
          })
        });
      }
      
      alert("Auditoría completada. Reporte en proceso.");
    });
    
    async function uploadImage(imageData) {
      const response = await fetch(`${SCRIPT_URL}?function=uploadImage`, {
        method: 'POST',
        body: JSON.stringify({image: imageData})
      });
      const data = await response.json();
      return data.url;
    }
  </script>
</body>
</html>
